# VK homework bot
Бот ВКонтакте для использования в школе

## Начало работы

После копирования репозитория необходимо изменить настройки бота в `config/config.php`:

    /* Настройки базы данных */
    const DB_NAME = 'database_name'; // Название базы данных
    const DB_USER = 'user_name'; // Имя пользователя базы данных
    const DB_PW = 'user_password'; // Пароль от базы даных
    const DB_HW_TABLE = 'homework_table_name'; // Название таблицы для домашнего задания
    
    /* Настройки API ВКонтакте */
    // Используемая версия API, должна совпадать с версией,
    // которая указана в настройках сообщества (Управление ->
    // -> Настройки -> Работа с API -> Callback API -> Версия API)
    const VK_API_VERSION = '5.92';
    // Код подтверждения Callback API (Управление -> Настройки ->
    // -> Работа с API -> Callback API -> Строка, которую должен вернуть сервер)
    const CALLBACK_API_CONFIRMATION_TOKEN = '00000000';
    // Код доступа сообщества (Управление -> Настройки -> Работа с API -> Ключи доступа)
    // N.B.: ключ должен иметь доступ к сообщениям сообщества
    const VK_API_ACCESS_TOKEN = '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
    // Идентификатор сообщества
    const COMMUNITY_ID = 000000000;
    
Далее необходимо настроить расписание в файле `config/timeTable.json`

    {
      "Mon": [/* Массив уроков в понедельник */],
      "Tue": [/* Вторник */],
      // ...
      "Sat": [/* Суббота */],
      "Sun": []
    }
    
Обратите внимание, что для занятий с разделением по группам нужно дописывать номер группы в виде '1гр' и '2гр'

Так же вы можете вручную изменить периоды каникул в `config/vacations.json` и задать дополнительные выходные в `config/weekends.json` (Это можно сделать с помощью встроенных команд бота)
    
### Дополнительные настройки
Вы можете настроить все возможные фразы в `config/Phrases.php`

    class Phrases {
        const EXPECTED_ANSWERS => [
            'POSITIVE' => [/* Массив положительных ответов */],
            'NEGATIVE' => [/* Массив отрицательных ответов */],
        ];
        const PREDEFINED => [
            /* 
                Массив статических ответов вида
                '/Регулярное выражение/ui' => ['Массив ответов'] 
            */,
            
            // Это выражение должно идти последним, выполняется, 
            // если сообщение не подошло ни к одному выражению
            '//ui' => [/* ... */]
        ];
        
        // Все возможные фразы
        // ... 
    }
    
## Использование
1. Сначала необходимо настроить сообщество ВК
    1. Создайте сообщество, если она ещё не существует
    2. Перейдите в _Управление сообществом_
    3. В разделе _Сообщения_ измените _Сообщения сообщества_ на _Включены_
    4. В разделе _Сообщения -> Настройки для бота_ измените _Возможности ботов_ на _Включены_
    5. Если вы планирует добавлять бота в беседы, также отметьте переключатель _Разрешать добавлять сообщество в беседы_
    6. В разделе _Настройки -> Работа с API -> Ключи доступа_ необходимо создать новый ключ (при создании отметьте переключатель _Разрешить приложению доступ к сообщениям сообщества_), далее подтвердить его
    7. В разделе _Настройки -> Работа с API -> Callback API_ укажите желаемую версию API (Примечание: API ВКонтакте был переработан с версии 5.80, поэтому с более ранними версиями бот работать не будет)
2. Загрузите бота на ваш сервер (в том числе загрузите/создайте пустые папки `logs` и `temp`) и измените настройки, как указано в пункте ___"Начало работы"___
3. Снова зайдите в _Управление сообществом_ и в разделе _Настройки -> Работа с API -> Callback API_ укажите путь к файлу `launchBot.php` на вашем сервере
4. Нажмите `подтвердить`. Если вы указали верные данные, подтверждение пройдет успешно

## Команды
_Примечание:_ бот распознаёт большинство фраз по первым буквам, поэтому он одинаково воспримет такие слова как "добавить", "добавь", "добав", "добавофышпвыгр" и т.п.

- `Добавь на [дата] по [предмет] [задание]` или `Добавь по [предмет] [задание]`

    _Примечание:_ дату и предмет с предлогами можно ставить в любом месте после слова "добавь", тем не менее лучше писать в начале, тогда больше шансов верного определения данных
    
    Добавляет _[задание]_ по _[предмету]_ на _[дату]_  
    Если дата не указана, находит ближайший день, содержащий _[предмет]_ и записывает _[задание]_ на него  
    Для предметов с разделением по группам по умолчанию добавляет задание для первой группы. Для записи на вторую группу добавьте "2гр"
    
   __Примеры__:  
   `Добавь по алгебре на 7.02 упр.203, 302, 204` - добавит "упр.203, 302, 204" на 7 февраля по алгебре  
   `Добавь по русскому упр.5, 7` - добавит "упр.5, 7" по русскому у 1 группы на ближайший день, содержащий русский у 1 группы  
   `Добавь по английскому 2гр пункт 7, упр.8` - Добавит "пункт 7, упр.8" по английскому у 2 группы 
    
    См. [Форматы даты](#date-formats)
    
- `Что на [дата] по [предмет]` или `Что на [дата]` или `Что по [предмет]` или `Что по [предмет] на [дата]` или `Что задали`
    
    Находит домашнее задание по _[предмету]_ на _[дату]_  
    Если предмет указан, дата не указана, находит задание по _[предмету]_ на ближайший день, содержащий _[предмет]_  
    Если дата указана, а предмет не указан, находит задание по всем предметам, которые есть на _[дату]_  
    Если ни предмет, ни дата не указаны, находит задание по всем предметам на ближайший рабочий день
    
    __Примеры__:  
    `Что на 5 апреля по алгебре`  
    `Что по английскому`  
    `Что на сегодня`    
    `Что задали`
    
    См. [Форматы даты](#date-formats)
    
- `Удали задание по [предмет] на [дата]` или `Удали задание на [дата] по [предмет]`
    
    Удаляет задание по _[предмету]_ на _[дату]_
    
    __Примеры__:  
    `Удали задание по русскому на 5 января`  
    `Удалить задание на завтра по литре`
    
- `Добавь выходной на [дата]`

    Отмечает _[дату]_ как выходной день
    
    __Примеры__:  
    `Добавь выходной на 8 марта`
    
- `Удали выходной на [дата]`

    Отмечает _[дату]_ как рабочий день
    
    __Примеры__:  
    `Удали выходной на 23.02`
    
- `Когда каникулы` или `Сколько до каникул`

    Находит ближайшие каникулы и разницу между датой их начала и текущим днём  
    
    
- `Измени каникулы [каникулы] с [дата1]` или `Измени каникулы [каникулы] с [дата1] по [дата2]`

    Изменяет периоды каникул _[каникулы]_  
    Если указана одна дата, изменяет начало каникул на _[дату]_  
    Если указаны две даты, изменяет начало каникул на _[дату1]_ и конец на _[дату2]_
    
    __Примеры__:  
    `Измени каникулы летние с 15 мая`  
    `Измени каникулы зимние с 25.12 по 09 января`
    
### <a name="date-formats"></a> Форматы даты

- `\d{1,2}[^\p{L}]\d{1,2}`
    
    `12.11` - 12 ноября  
    `02.09` - 2 сентября  
    `2:06`- 2 июня  
    `4/2` - 4 февраля

- `\d{1,2}\s*(янв|фев|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек)`
    
    `14 апреля`  
    `2    марта`  
    `07 июня`
    
- `(по?н|вт|ср|че?т|пя?т|су?б|во?с)` - ближайший указанный день недели

    `понедельник`  
    `среда`  
    `сб`
    
- `\d{1,2}` - ближайшее указанное число текущего/следующего месяца

    `на 12`  
    `на 7`
    
- `сегодня`
- `завтра`
- `вчера`

## <a name="formats"></a> Работа с предметами

Если нужного предмета нет в настройках бота, его можно добавить следующим способом:

1. Откройте файл `util/Subject.php`
2. В начале класса после констант предметов (последняя из них `Subject::CHEMISTRY`) добавьте ещё одну и присвойте ей название предмета, например

        class Subject {
            // ...
            const CHEMISTRY = 'химия';
            
            // Ваш предмет:
            const GEOGRAPHY = 'география';
            
            // ...
        }
3. Далее измените регулярное выражение ниже
        
        // ...
        
        //                  Добавьте сюда начало названия нового предмета \/
        const REGEX = "алг|геом|мат|[аи]нг|био|ист|кит|лит|общ|рус|физ|хим|геог";
        
        // ...
        
4. В массиве `Subject::DESC` необходимо настроить ваш предмет. Добавьте новый элемент: его ключом должна быть созданная в п.2 константа, а значением массив настроек: регулярное выражение для распознавания предмета (в большинстве случаев то же, что вы добавили в п.3), дательный и родительный падежи предмета

        // ...
        const DESC = [
            // ...
            self::CHEMISTRY => [
                'dat' => 'химии',
                'gen' => 'химии',
                'regex' => 'хим',
            ],
            
            // Здесь идут настройки новго предмета:
            self::GEOGRAPHY => [
                'dat' => 'географии', // Дательный падеж
                'gen' => 'географии', // Родительный падеж
                'regex' => 'геог', // Регулярное выражение            
            ],    
        ];
        // ...
        
